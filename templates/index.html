<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Giant Brain AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: #000;
            height: 100vh;
            overflow: hidden;
            position: fixed;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        /* Ø­Ø§Ù„Øª Ú†Øª */
        .chat-mode {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0a0a;
            display: flex;
            flex-direction: column;
            color: #fff;
        }
        
        /* Ø­Ø§Ù„Øª Ù…Ø¯ÛŒØ±ÛŒØª */
        .admin-mode {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0a0a;
            display: none;
            overflow-y: auto;
            color: #fff;
        }
        
        /* Ù‡Ø¯Ø± */
        .header {
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            padding: env(safe-area-inset-top, 20px) 20px 16px 20px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .info {
            flex: 1;
        }
        
        .name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 4px;
            background: linear-gradient(135deg, #fff, #a0a0a0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.8rem;
            color: #9ca3af;
        }
        
        .dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        .switch-btn {
            background: #333;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        /* Ù…Ù†Ø·Ù‚Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
            background: #0f0f0f;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .message {
            display: flex;
            width: 100%;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message.bot {
            justify-content: flex-start;
        }
        
        .bubble {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 22px;
            font-size: 0.95rem;
            line-height: 1.6;
            word-break: break-word;
        }
        
        .user .bubble {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            border-bottom-right-radius: 6px;
        }
        
        .bot .bubble {
            background: #1a1a1a;
            color: #fff;
            border-bottom-left-radius: 6px;
            border: 1px solid #333;
        }
        
        .time {
            font-size: 0.7rem;
            color: #6b7280;
            margin-top: 6px;
            margin-right: 14px;
        }
        
        /* ØªØ§ÛŒÙ¾ Ø§ÛŒÙ†Ø¯ÛŒÚ©ÛŒØªÙˆØ± */
        .typing {
            background: #1a1a1a;
            padding: 14px 22px;
            border-radius: 22px;
            border-bottom-left-radius: 6px;
            border: 1px solid #333;
            display: inline-flex;
            gap: 6px;
        }
        
        .typing span {
            width: 8px;
            height: 8px;
            background: #6b7280;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
            30% { transform: translateY(-8px); opacity: 1; }
        }
        
        /* ÙˆØ±ÙˆØ¯ÛŒ */
        .input-area {
            background: #0a0a0a;
            border-top: 1px solid #333;
            padding: 12px 16px env(safe-area-inset-bottom, 12px) 16px;
        }
        
        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: center;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 30px;
            padding: 4px 4px 4px 18px;
        }
        
        .input-wrapper:focus-within {
            border-color: #3b82f6;
            background: #222;
        }
        
        #userInput {
            flex: 1;
            border: none;
            background: transparent;
            padding: 12px 0;
            font-size: 1rem;
            outline: none;
            color: #fff;
        }
        
        #userInput::placeholder {
            color: #6b7280;
        }
        
        .send-btn {
            width: 48px;
            height: 48px;
            border: none;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        /* Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª */
        .admin-container {
            padding: 20px;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .admin-title {
            font-size: 1.5rem;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #333;
        }
        
        .stat-card h3 {
            color: #9ca3af;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 600;
            color: #3b82f6;
        }
        
        .learn-section {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid #333;
        }
        
        .learn-section h2 {
            margin-bottom: 20px;
            color: #fff;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #9ca3af;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            outline: none;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
        }
        
        .btn-secondary {
            background: #333;
            color: white;
        }
        
        .status-badge {
            background: #333;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        
        .status-badge.training {
            background: #f59e0b;
            color: black;
        }
        
        .status-badge.idle {
            background: #10b981;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Ø­Ø§Ù„Øª Ú†Øª -->
    <div class="chat-mode" id="chatMode">
        <div class="header">
            <div class="avatar">ğŸ§ </div>
            <div class="info">
                <div class="name">Giant Brain AI</div>
                <div class="status">
                    <span class="dot"></span>
                    <span>Û´Û¸ Ù„Ø§ÛŒÙ‡ Â· Û²ÛµÛ³B Ù¾Ø§Ø±Ø§Ù…ØªØ±</span>
                </div>
            </div>
            <button class="switch-btn" onclick="switchMode('admin')">âš™ï¸</button>
        </div>
        
        <div class="messages" id="messages"></div>
        
        <div class="input-area">
            <div class="input-wrapper">
                <input type="text" id="userInput" placeholder="Ø³ÙˆØ§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù¾Ø±Ø³...">
                <button class="send-btn" onclick="sendMessage()">ğŸ“¤</button>
            </div>
        </div>
    </div>
    
    <!-- Ø­Ø§Ù„Øª Ù…Ø¯ÛŒØ±ÛŒØª -->
    <div class="admin-mode" id="adminMode">
        <div class="header">
            <div class="avatar">âš™ï¸</div>
            <div class="info">
                <div class="name">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</div>
                <div class="status">
                    <span class="dot" id="trainingDot"></span>
                    <span id="trainingStatus">Ø¢Ù…Ø§Ø¯Ù‡</span>
                </div>
            </div>
            <button class="switch-btn" onclick="switchMode('chat')">ğŸ’¬</button>
        </div>
        
        <div class="admin-container">
            <!-- Ø¢Ù…Ø§Ø± -->
            <div class="stats-grid" id="stats">
                <div class="stat-card">
                    <h3>Ú¯Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´</h3>
                    <div class="stat-number" id="statSteps">0</div>
                </div>
                <div class="stat-card">
                    <h3>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Loss</h3>
                    <div class="stat-number" id="statLoss">0</div>
                </div>
                <div class="stat-card">
                    <h3>Ø­Ø§ÙØ¸Ù‡</h3>
                    <div class="stat-number" id="statMemory">0</div>
                </div>
                <div class="stat-card">
                    <h3>ÙˆØ§Ú˜Ú¯Ø§Ù†</h3>
                    <div class="stat-number" id="statVocab">0</div>
                </div>
            </div>
            
            <!-- ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø§Ø² Ù…ØªÙ† -->
            <div class="learn-section">
                <h2>ğŸ“ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø§Ø² Ù…ØªÙ†</h2>
                <div class="form-group">
                    <label>Ù…ØªÙ†:</label>
                    <textarea id="learnText" placeholder="Ù…ØªÙ† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø¨Ø±Ø§ÛŒ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="learnFromText()">ÛŒØ§Ø¯ Ø¨Ú¯ÛŒØ±</button>
            </div>
            
            <!-- ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø§Ø² ÙØ§ÛŒÙ„ -->
            <div class="learn-section">
                <h2>ğŸ“ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø§Ø² ÙØ§ÛŒÙ„</h2>
                <div class="form-group">
                    <label>Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„:</label>
                    <input type="file" id="learnFile" accept=".txt,.md">
                </div>
                <button class="btn btn-primary" onclick="learnFromFile()">Ø¢Ù¾Ù„ÙˆØ¯ Ùˆ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ</button>
            </div>
            
            <!-- ÙˆØ¶Ø¹ÛŒØª Ø¢Ù…ÙˆØ²Ø´ -->
            <div class="learn-section">
                <h2>âš¡ ÙˆØ¶Ø¹ÛŒØª Ø¢Ù…ÙˆØ²Ø´</h2>
                <div style="margin-bottom: 15px;">
                    <span class="status-badge" id="trainingStateBadge">Ø¢Ù…Ø§Ø¯Ù‡</span>
                </div>
                <div id="trainingProgress" style="margin-bottom: 15px; display: none;">
                    <div style="background: #333; height: 20px; border-radius: 10px; overflow: hidden;">
                        <div id="progressBar" style="background: linear-gradient(135deg, #3b82f6, #8b5cf6); width: 0%; height: 100%;"></div>
                    </div>
                    <div style="margin-top: 10px; color: #9ca3af;" id="progressText"></div>
                </div>
                <button class="btn btn-secondary" onclick="stopTraining()" id="stopBtn" style="display: none;">ØªÙˆÙ‚Ù Ø¢Ù…ÙˆØ²Ø´</button>
            </div>
            
            <!-- Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ -->
            <div class="learn-section">
                <h2>ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</h2>
                <button class="btn btn-primary" onclick="saveBrain()">Ø°Ø®ÛŒØ±Ù‡ Ù…ØºØ²</button>
                <button class="btn btn-secondary" onclick="loadBrain()">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ø®Ø±ÛŒÙ† Ù…Ø¯Ù„</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentMode = 'chat';
        let statsInterval;
        
        // ========== ØªØºÛŒÛŒØ± Ø­Ø§Ù„Øª ==========
        function switchMode(mode) {
            currentMode = mode;
            if (mode === 'chat') {
                document.getElementById('chatMode').style.display = 'flex';
                document.getElementById('adminMode').style.display = 'none';
            } else {
                document.getElementById('chatMode').style.display = 'none';
                document.getElementById('adminMode').style.display = 'block';
                loadStats();
                startStatsInterval();
            }
        }
        
        // ========== ØªÙˆØ§Ø¨Ø¹ Ú†Øª ==========
        function addMessage(text, sender) {
            const messages = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${sender}`;
            
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            bubble.innerText = text;
            
            const time = document.createElement('div');
            time.className = 'time';
            const now = new Date();
            time.innerText = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            msgDiv.appendChild(bubble);
            msgDiv.appendChild(time);
            messages.appendChild(msgDiv);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function showTyping() {
            const messages = document.getElementById('messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.id = 'typing';
            typingDiv.innerHTML = `
                <div class="typing">
                    <span></span><span></span><span></span>
                </div>
            `;
            messages.appendChild(typingDiv);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function hideTyping() {
            const typing = document.getElementById('typing');
            if (typing) typing.remove();
        }
        
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const msg = input.value.trim();
            if (!msg) return;
            
            addMessage(msg, 'user');
            input.value = '';
            showTyping();
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message: msg})
                });
                
                const data = await response.json();
                hideTyping();
                addMessage(data.response, 'bot');
            } catch (error) {
                hideTyping();
                addMessage('Ø®Ø·Ø§: ' + error.message, 'bot');
            }
        }
        
        // ========== ØªÙˆØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª ==========
        async function loadStats() {
            try {
                const response = await fetch('/api/brain/stats');
                const data = await response.json();
                
                document.getElementById('statSteps').innerText = data.step || 0;
                document.getElementById('statLoss').innerText = (data.avg_loss || 0).toFixed(4);
                document.getElementById('statMemory').innerText = data.memory_size || 0;
                document.getElementById('statVocab').innerText = data.vocab_size || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        async function checkTrainingStatus() {
            try {
                const response = await fetch('/api/learn/status');
                const data = await response.json();
                
                const statusEl = document.getElementById('trainingStatus');
                const dotEl = document.getElementById('trainingDot');
                const badgeEl = document.getElementById('trainingStateBadge');
                const progressDiv = document.getElementById('trainingProgress');
                const stopBtn = document.getElementById('stopBtn');
                
                if (data.is_training) {
                    statusEl.innerText = 'Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…ÙˆØ²Ø´';
                    dotEl.style.background = '#f59e0b';
                    badgeEl.innerText = 'Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…ÙˆØ²Ø´';
                    badgeEl.className = 'status-badge training';
                    progressDiv.style.display = 'block';
                    stopBtn.style.display = 'inline-block';
                    
                    if (data.total_files > 0) {
                        const progress = (data.progress / data.total_files) * 100;
                        document.getElementById('progressBar').style.width = progress + '%';
                        document.getElementById('progressText').innerText = 
                            `Ù¾Ø±Ø¯Ø§Ø²Ø´ ${data.current_file} (${data.progress}/${data.total_files})`;
                    }
                } else {
                    statusEl.innerText = 'Ø¢Ù…Ø§Ø¯Ù‡';
                    dotEl.style.background = '#10b981';
                    badgeEl.innerText = 'Ø¢Ù…Ø§Ø¯Ù‡';
                    badgeEl.className = 'status-badge idle';
                    progressDiv.style.display = 'none';
                    stopBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking training status:', error);
            }
        }
        
        function startStatsInterval() {
            if (statsInterval) clearInterval(statsInterval);
            statsInterval = setInterval(() => {
                loadStats();
                checkTrainingStatus();
            }, 2000);
        }
        
        async function learnFromText() {
            const text = document.getElementById('learnText').value.trim();
            if (!text) {
                alert('Ù…ØªÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            try {
                const response = await fetch('/api/learn/text', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({text: text})
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(`âœ… ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯! Loss: ${data.loss.toFixed(4)}`);
                    document.getElementById('learnText').value = '';
                    loadStats();
                }
            } catch (error) {
                alert('Ø®Ø·Ø§: ' + error.message);
            }
        }
        
        async function learnFromFile() {
            const fileInput = document.getElementById('learnFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('ÙØ§ÛŒÙ„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/learn/file', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(`âœ… ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø§Ø² ÙØ§ÛŒÙ„ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯! Loss: ${data.loss.toFixed(4)}`);
                    fileInput.value = '';
                    loadStats();
                }
            } catch (error) {
                alert('Ø®Ø·Ø§: ' + error.message);
            }
        }
        
        async function stopTraining() {
            try {
                await fetch('/api/learn/stop', {method: 'POST'});
            } catch (error) {
                console.error('Error stopping training:', error);
            }
        }
        
        async function saveBrain() {
            try {
                const response = await fetch('/api/brain/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({filename: 'manual_save.pt'})
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('âœ… Ù…ØºØ² Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
                }
            } catch (error) {
                alert('Ø®Ø·Ø§: ' + error.message);
            }
        }
        
        async function loadBrain() {
            try {
                const response = await fetch('/api/brain/load', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({filename: 'best_model.pt'})
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('âœ… Ù…ØºØ² Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
                    loadStats();
                } else {
                    alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ');
                }
            } catch (error) {
                alert('Ø®Ø·Ø§: ' + error.message);
            }
        }
        
        // ========== Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ ==========
        document.getElementById('userInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        // Load initial stats
        loadStats();
    </script>
</body>
          </html>
